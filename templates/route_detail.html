<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>{{ route.title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <style>
    .btn {
      padding: 5px 10px;
      margin: 5px;
      cursor: pointer;
    }
    #comments-container {
      margin-top: 15px;
    }
    /* Стили для звёздного рейтинга */
    .star-rating {
      display: inline-block;
      direction: rtl;
      font-size: 1.2em;
    }
    .star-rating input[type="radio"] {
      display: none;
    }
    .star-rating label {
      color: #ccc;
      cursor: pointer;
    }
    .star-rating input[type="radio"]:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label {
      color: #FFD700;
    }
    /* Контейнер карты */
    #map {
      width: 100%;
      height: 400px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>{{ route.title }}</h1>
    {% if current_user.is_authenticated %}
      <a href="{{ url_for('user_profile', user_id=current_user.id) }}">Профиль</a>
    {% else %}
      <a href="{{ url_for('login') }}">Войти</a>
    {% endif %}
  </header>
  
  <section>
    <p>{{ route.description }}</p>
    <p><small>Создан: {{ route.created_at.strftime("%d-%m-%Y %H:%M") }}</small></p>
    
    <!-- Отметка посещения -->
    {% if current_user.is_authenticated %}
      <form action="{{ url_for('mark_visit', route_id=route.id) }}" method="POST" id="visit-form">
        <button type="submit" class="btn">Я посетил маршрут</button>
      </form>
    {% endif %}
    
    <!-- Блок лайков и рейтинга -->
    <div>
      <span>Оценок: {{ route.ratings_count }}</span> |
      <span>Средний рейтинг: {{ route.average_rating }} ★</span>
      {% if current_user.is_authenticated %}
      <form action="{{ url_for('rate_route', route_id=route.id) }}" method="POST" style="display:inline;">
        <div class="star-rating">
          <input type="radio" id="star5-route-{{ route.id }}" name="rating" value="5" {% if user_rating == 5 %}checked{% endif %} required>
          <label for="star5-route-{{ route.id }}">★</label>
          <input type="radio" id="star4-route-{{ route.id }}" name="rating" value="4" {% if user_rating == 4 %}checked{% endif %}>
          <label for="star4-route-{{ route.id }}">★</label>
          <input type="radio" id="star3-route-{{ route.id }}" name="rating" value="3" {% if user_rating == 3 %}checked{% endif %}>
          <label for="star3-route-{{ route.id }}">★</label>
          <input type="radio" id="star2-route-{{ route.id }}" name="rating" value="2" {% if user_rating == 2 %}checked{% endif %}>
          <label for="star2-route-{{ route.id }}">★</label>
          <input type="radio" id="star1-route-{{ route.id }}" name="rating" value="1" {% if user_rating == 1 %}checked{% endif %}>
          <label for="star1-route-{{ route.id }}">★</label>
        </div>
        <button type="submit" class="btn">Оценить</button>
      </form>
      {% endif %}
    </div>
    
    <!-- Контейнер для карты -->
    <div id="map"></div>
    
    <!-- Скрытые поля с данными маршрута.
         Если данные в базе уже сохранены как JSON-строки, выводите их через safe, без tojson -->
    <input type="hidden" id="points" value='{{ route.points|safe if route.points else "[]" }}'>
    <input type="hidden" id="allMarkers" value='{{ route.allMarkers|safe if route.allMarkers else "[]" }}'>
    <input type="hidden" id="landmarks" value='{{ route_landmarks | tojson | safe }}'>
    <!-- Скрытое поле для route.id (если нужно) -->
    <input type="hidden" id="route-id" value="{{ route.id }}">
    
    <!-- Форма добавления комментария (без поля оценки) -->
    {% if current_user.is_authenticated %}
      <h2>Добавить комментарий</h2>
      <form action="{{ url_for('add_comment', route_id=route.id) }}" method="POST">
        <div>
          <textarea name="text" placeholder="Ваш комментарий" required></textarea>
        </div>
        <button type="submit" class="btn">Отправить</button>
      </form>
    {% endif %}
    
    <!-- Комментарии -->
    <div id="comments-section">
      <button id="load-comments" class="btn">Показать комментарии</button>
      <div id="comments-container"></div>
    </div>
    
    <a href="{{ url_for('index') }}">Назад на главную</a>
  </section>
  
  <script>
    // AJAX-загрузка комментариев при нажатии кнопки
    document.getElementById('load-comments').addEventListener('click', function() {
      fetch("{{ url_for('route_comments', route_id=route.id) }}")
        .then(response => response.text())
        .then(html => {
          document.getElementById('comments-container').innerHTML = html;
          document.getElementById('load-comments').style.display = 'none';
        });
    });
  </script>
  
  <!-- Подключаем сначала jQuery, затем Яндекс.Карты -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://api-maps.yandex.ru/2.1/?apikey=87ec7ba4-2222-482d-b49f-11bdee31019b&lang=ru_RU"></script>
  
  <!-- Скрипт для отображения маршрута на карте (read-only) -->
  <!-- Скрипт для отображения маршрута на карте (read-only, без редактирования) -->
<script>
  ymaps.ready(function(){
    // Функция, которая гарантирует, что данные – массив
    function ensureArray(data) {
      return Array.isArray(data) ? data : Object.values(data);
    }
    
    // Читаем данные из скрытых полей
    let pointsData = JSON.parse(document.getElementById('points').value);
    let allMarkersData = JSON.parse(document.getElementById('allMarkers').value);
    let landmarksData = JSON.parse(document.getElementById('landmarks').value);
    
    console.log("pointsData (raw):", pointsData);
    console.log("allMarkersData (raw):", allMarkersData);
    console.log("landmarksData (raw):", landmarksData);
    
    // Приводим данные к массиву
    pointsData = ensureArray(pointsData);
    allMarkersData = ensureArray(allMarkersData);
    landmarksData = ensureArray(landmarksData);
    
    // Приводим координаты к числовым значениям
    allMarkersData = allMarkersData.map(m => ({ lat: Number(m.lat), lng: Number(m.lng) }));
    pointsData = pointsData.map(m => ({ lat: Number(m.lat), lng: Number(m.lng) }));
    landmarksData = landmarksData.map(lm => ({
      lat: Number(lm.lat),
      lng: Number(lm.lng),
      name: lm.name || '',
      description: lm.description || '',
      photo_url: lm.photo_url || ''
    }));
    
    console.log("allMarkersData (числовые, до фильтра):", allMarkersData);
    console.log("pointsData (числовые):", pointsData);
    console.log("landmarksData (числовые):", landmarksData);
    
    // Фильтруем объекты с недействительными координатами
    allMarkersData = allMarkersData.filter(m => !isNaN(m.lat) && !isNaN(m.lng));
    pointsData = pointsData.filter(m => !isNaN(m.lat) && !isNaN(m.lng));
    landmarksData = landmarksData.filter(m => !isNaN(m.lat) && !isNaN(m.lng));
    
    console.log("allMarkersData (числовые, отфильтрованные):", allMarkersData);
    
    // Если pointsData непустое, а landmarksData пустое, генерируем landmarksData как разницу
    if (pointsData.length > 0 && landmarksData.length === 0) {
      landmarksData = allMarkersData.filter(marker => {
        return !pointsData.some(pt =>
          Math.abs(pt.lat - marker.lat) < 1e-6 &&
          Math.abs(pt.lng - marker.lng) < 1e-6
        );
      });
      console.log("Сгенерированные landmarksData:", landmarksData);
    } else if (pointsData.length === 0) {
      console.warn("pointsData пустое – достопримечательностей не определяем.");
      landmarksData = [];
    }
    
    // Определяем центр карты: используем первую точку из allMarkersData, если есть
    let center = ['55.755864', '37.617698'];
    if (allMarkersData.length > 0) {
      center = [allMarkersData[0].lat, allMarkersData[0].lng];
    }
    console.log("Центр карты:", center);
    
    // Инициализируем карту
    const map = new ymaps.Map("map", {
      center: center,
      zoom: 10
    });
    
    // Функция сравнения координат с допуском
    function coordsEqual(a, b) {
      return Math.abs(a - b) < 1e-6;
    }
    
    // Функция создания маркера (read-only)
    function createMarker(coordsObj, isLandmark, landmarkData = {}) {
      const coords = [coordsObj.lat, coordsObj.lng];
      if (isNaN(coords[0]) || isNaN(coords[1])) {
        console.warn("Неверные координаты при создании маркера:", coordsObj);
        return null;
      }
      const marker = new ymaps.Placemark(coords, {}, { draggable: false });
      if (isLandmark) {
        marker.options.set('preset', 'islands#redIcon');
        // Если имя задано, используем его, иначе оставляем значение по умолчанию
        const name = landmarkData.name ? landmarkData.name : "Достопримечательность";
        marker.properties.set('hintContent', name);
        let balloonContent = "<strong>" + name + "</strong>";
        if (landmarkData.description) {
          balloonContent += "<br>" + landmarkData.description;
        }
        marker.properties.set('balloonContent', balloonContent);
        // При клике открываем балун
        marker.events.add("click", function() {
          marker.balloon.open();
        });
        console.log("Создан красный маркер:", coords, "с данными:", landmarkData);
      } else {
        marker.options.set('preset', 'islands#blueIcon');
        marker.properties.set('hintContent', 'Обычная точка маршрута');
        console.log("Создан синий маркер:", coords);
      }
      map.geoObjects.add(marker);
      return marker;
    }
    
    // Создаем маркеры по данным allMarkersData.
    let markersArray = [];
    allMarkersData.forEach(markerData => {
      let isLandmark = false;
      let lmData = {};
      console.log("Обработка точки:", markerData);
      for (let lm of landmarksData) {
        if (coordsEqual(lm.lat, markerData.lat) && coordsEqual(lm.lng, markerData.lng)) {
          isLandmark = true;
          lmData = lm;
          console.log("Точка распознана как достопримечательность:", lm);
          break;
        }
      }
      const marker = createMarker(markerData, isLandmark, lmData);
      if (marker) markersArray.push(marker);
    });
    
    // Если маркеров больше одного, создаем мультимаршрут между ними
    if (markersArray.length > 1) {
      const referencePoints = allMarkersData.map(pt => [pt.lat, pt.lng]);
      const multiRoute = new ymaps.multiRouter.MultiRoute({
        referencePoints: referencePoints,
        params: { routingMode: 'auto' }
      }, {
        boundsAutoApply: true,
        wayPointVisible: false,
        routeBalloonVisible: false,
        routeStrokeWidth: 4,
        routeStrokeColor: "#1E90FF",
        routeActiveStrokeWidth: 6,
        routeActiveStrokeColor: "#FF4500"
      });
      map.geoObjects.add(multiRoute);
      console.log("Создан мультимаршрут между точками:", referencePoints);
    }
  });
</script>

</body>