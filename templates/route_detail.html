<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>{{ route.title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <style>
    .btn {
      padding: 5px 10px;
      margin: 5px;
      cursor: pointer;
    }
    #comments-container {
      margin-top: 15px;
    }
    /* Стили для звёздного рейтинга */
    .star-rating {
      display: inline-block;
      direction: rtl;
      font-size: 1.2em;
    }
    .star-rating input[type="radio"] {
      display: none;
    }
    .star-rating label {
      color: #ccc;
      cursor: pointer;
    }
    .star-rating input[type="radio"]:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label {
      color: #FFD700;
    }
  </style>
</head>
<body>
  <header>
    <h1>{{ route.title }}</h1>
    <a href="{{ url_for('user_profile', user_id=current_user.id) }}">Профиль</a>
  </header>
  <section>
    <p>{{ route.description }}</p>
    <p><small>Создан: {{ route.created_at.strftime("%d-%m-%Y %H:%M") }}</small></p>
    
    <!-- Отметка посещения -->
    {% if current_user.is_authenticated %}
      <form action="{{ url_for('mark_visit', route_id=route.id) }}" method="POST" id="visit-form">
        <button type="submit" class="btn">Я посетил маршрут</button>
      </form>
    {% endif %}
    
    <!-- Лайки, средний рейтинг и форма оценки -->
    <div>
      <span>Лайков: {{ route.likes_count }}</span> |
      <span>Средний рейтинг: {{ route.average_rating }} ★</span>
      {% if current_user.is_authenticated %}
      <form action="{{ url_for('rate_route', route_id=route.id) }}" method="POST" style="display:inline;">
        <div class="star-rating">
          <input type="radio" id="star5-route-{{ route.id }}" name="rating" value="5" {% if user_rating == 5 %}checked{% endif %} required>
          <label for="star5-route-{{ route.id }}">★</label>
          <input type="radio" id="star4-route-{{ route.id }}" name="rating" value="4" {% if user_rating == 4 %}checked{% endif %}>
          <label for="star4-route-{{ route.id }}">★</label>
          <input type="radio" id="star3-route-{{ route.id }}" name="rating" value="3" {% if user_rating == 3 %}checked{% endif %}>
          <label for="star3-route-{{ route.id }}">★</label>
          <input type="radio" id="star2-route-{{ route.id }}" name="rating" value="2" {% if user_rating == 2 %}checked{% endif %}>
          <label for="star2-route-{{ route.id }}">★</label>
          <input type="radio" id="star1-route-{{ route.id }}" name="rating" value="1" {% if user_rating == 1 %}checked{% endif %}>
          <label for="star1-route-{{ route.id }}">★</label>
        </div>
        <button type="submit" class="btn">Оценить</button>
      </form>
      {% endif %}
    </div>
    
    <!-- Комментарии -->
    <div id="comments-section">
      <button id="load-comments" class="btn">Показать комментарии</button>
      <div id="comments-container"></div>
    </div>
    
    <!-- Форма добавления комментария (без поля оценки) -->
    {% if current_user.is_authenticated %}
    <h2>Добавить комментарий</h2>
    <form action="{{ url_for('add_comment', route_id=route.id) }}" method="POST">
      <div>
        <textarea name="text" placeholder="Ваш комментарий" required></textarea>
      </div>
      <button type="submit">Отправить</button>
    </form>
    {% endif %}
    
    <a href="{{ url_for('index') }}">Назад на главную</a>
  </section>
  
  <script>
    // AJAX-загрузка комментариев при нажатии кнопки
    document.getElementById('load-comments').addEventListener('click', function() {
      fetch("{{ url_for('route_comments', route_id=route.id) }}")
        .then(response => response.text())
        .then(html => {
          document.getElementById('comments-container').innerHTML = html;
          document.getElementById('load-comments').style.display = 'none';
        });
    });
  </script>
</body>
</html>
